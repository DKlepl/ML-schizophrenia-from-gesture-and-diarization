---
title: "Feature Engineering"
author: "Dominik Klepl"
date: "10/15/2018"
output: html_document
---

After the preprocessing phase the data is clean, actigraph data is tagged by speaker. Before the features can be extracted data from every participant will be split into small snippets and in 2 categories: single signal and synergy. 
All snippets will be 10 seconds long. First I split all actigraph timeseries into smaller files which will have only signal of the speaker in given 10 seconds.
Then these single speaker signals will be combined into consequtive pairs of signals for synergy analysis.

# 1. Single signal splitting

Load all actigraph files from folder, choose one sample
```{r}
all_data = list.files("clean_data/Gesture", full.names = T)

filename = all_data[1]

data = read.csv(filename)
data = data[,-1]
anyNA(data)
```

Extract info from the filename
```{r}
get_info = function(file) {
  filename = strsplit(file, "/")[[1]][3]
  split = strsplit(filename, "_")[[1]]
  info = data.frame(ID = split[1],
                    right = split[2])
  
  return(info)
}

inf = get_info(filename)
```

Split the data by interlocutor and split these into 10 seconds long files. Save them in separate folders
```{r}
sampling = 100 #sampling of actigraph is 100 Hz
len = 10 #split into 10 seconds long
split = len * sampling

data_psych = subset(data, interviewer==1)
data_part = subset(data, interviewer==0)

rownames(data_psych)=NULL
rownames(data_part)=NULL

n_splits_psych = trunc((nrow(data_psych)/split),0)
n_splits_part = trunc((nrow(data_part)/split),0)

#trim data to have lenght dividable by number of splits
data_psych = data_psych[1:(n_splits_psych*split),]
data_part = data_part[1:(n_splits_part*split),]

data_psych$split = rep(1:n_splits_psych,each=split)
data_part$split = rep(1:n_splits_part, each=split)

splitted_psych = split(data_psych, data_psych$split)
splitted_part = split(data_part, data_part$split)

#loop through the list of dataframes, count utterances and save into its interlocutor's folder
for (d in 1:length(splitted_psych)) {
  dataframe = splitted_psych[[d]]
  save_path = "clean_data/Split_data/Interviewer/"
  filename = paste(info$ID, info$right, d, ".csv", sep = "_")
  save_as = paste0(save_path, filename)
  
  write.csv(dataframe, save_as)
}

#the same for splitted_part
for (d in 1:length(splitted_part)) {
  dataframe = splitted_part[[d]]
  save_path = "clean_data/Split_data/Participant/"
  filename = paste(inf$ID, inf$right, d, ".csv", sep = "_")
  save_as = paste0(save_path, filename)
  
  write.csv(dataframe, save_as)
}
```

# 2. Forming coordination pairs
Use the already splitted data into 10 seconds long chunks, combine them into pairs using the chunk order number (in the name of the file).

First delete those data splits that cannot be matched because that interlocutor didn't speak that much.
```{r}
#copy contents of 'Interviewer' folder into 'Coordination/Interviewer_copy'
original_interviewer = "clean_data/Split_data/Interviewer"
copy_interviewer = "clean_data/Split_data/Coordination/Interviewer_copy"
i_files = list.files(original_interviewer, full.names = T)
i_copy_success = file.copy(i_files, copy_interviewer)
sum(i_copy_success==F)

#copy contents of 'Participant' folder into 'Coordination/Participant_copy'
original_participant = "clean_data/Split_data/Participant"
copy_participant = "clean_data/Split_data/Coordination/Participant_copy"
p_files = list.files(original_participant, full.names = T)
p_copy_success = file.copy(p_files, copy_participant)
sum(p_copy_success==F)

#load all files from the 'Interviewer' and 'Participant' folders inside of Coordination folder
interviewer_files = list.files("clean_data/Split_data/Coordination/Interviewer_copy")
participant_files = list.files("clean_data/Split_data/Coordination/Participant_copy")

no_match_i = interviewer_files[(interviewer_files %in% participant_files) ==F]
no_match_p = participant_files[(participant_files %in% interviewer_files) ==F]

#sanity check
length(interviewer_files)-length(no_match_i) == length(participant_files)-length(no_match_p)

#delete files from both directories
for (i in no_match_i) {
  folder = "clean_data/Split_data/Coordination/Interviewer_copy/"
  to_remove = paste0(folder, i)
  try(file.remove(to_remove, recursive = T, force = T),silent = T)
}

for (i in no_match_p) {
  folder = "clean_data/Split_data/Coordination/Participant_copy/"
  to_remove = paste0(folder, i)
  try(file.remove(to_remove, recursive = T, force = T), silent = T)
}
```

Now form the coordination pairs, keep only relevant columns and save to new csv files.
```{r}
#list all files in one interlocutor's folder (doesnt matter which)
all_files = list.files("clean_data/Split_data/Coordination/Interviewer_copy")

#make the code work for one data split
filename = all_files[1]

#folders where all data splits are
interviewer_folder = "clean_data/Split_data/Coordination/Interviewer_copy/"
participant_folder = "clean_data/Split_data/Coordination/Participant_copy/"

#construct the name of the 2 data splits
interviewer_file = paste0(interviewer_folder, filename)
participant_file = paste0(participant_folder, filename)

data_interviewer = read.csv(interviewer_file)
data_participant = read.csv(participant_file)

#remove and rename columns to have unique column names in both dataframes
data_interviewer = data_interviewer[,c(-4, -6)]
colnames(data_interviewer) = c("PsychologistJerkLeft", "PsychologistJerkRight", "time_int", "utterance_n_int")

data_participant = data_participant[,c(-4,-6)]
colnames(data_participant) = c("ParticipanttJerkLeft", "ParticipantJerkRight", "time_par", "utterance_n_par")

coordination_pair = cbind(data_interviewer, data_participant)

#order the columns nicer
coordination_pair = coordination_pair[,c(1,2,5,6,3,7,4,8), drop=F]

#is the participant right- or left-handed?
right = as.numeric(strsplit(filename,"_")[[1]][2])

#keep only signal from the dominant hand of participant, unless that signal includes more than 200 zeroes, then keep the other hand signal
if (right==1) {
  if (sum(coordination_pair$ParticipantJerkRight==0)<200) {
    coordination_pair = coordination_pair[,-3]
  } else coordination_pair = coordination_pair[,-4]
} else {
  if (sum(coordination_pair$ParticipanttJerkLeft==0)<200) {
    coordination_pair = coordination_pair[,-4]
  } else coordination_pair = coordination_pair[,-3]
}

#keep only the signal from dominant hand of the psychologist (which is always right) unless the signal contains more than 200 zeroes, then keep the other hand signal
if (sum(coordination_pair$PsychologistJerkRight==0)<200) {
  coordination_pair = coordination_pair[,-1]
} else coordination_pair = coordination_pair[,-2]

#save the resulting file
save_file = paste0("clean_data/Split_data/Coordination/", filename)
write.csv(coordination_pair, save_file, row.names = F)
```



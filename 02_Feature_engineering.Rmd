---
title: "Feature Engineering"
author: "Dominik Klepl"
date: "10/15/2018"
output: html_document
---

After the preprocessing phase the data is clean, actigraph data is tagged by speaker. Before the features can be extracted data from every participant will be split into small snippets and in 2 categories: single signal and synergy. 
All snippets will be 10 seconds long. First I split all actigraph timeseries into smaller files which will have only signal of the speaker in given 10 seconds.
Then these single speaker signals will be combined into consequtive pairs of signals for synergy analysis.

# 1. Single signal splitting

Load all actigraph files from folder, choose one sample
```{r}
all_data = list.files("clean_data/Gesture", full.names = T)

filename = all_data[1]

data = read.csv(filename)
data = data[,-1]
anyNA(data)
```

Extract info from the filename
```{r}
get_info = function(file) {
  filename = strsplit(file, "/")[[1]][3]
  split = strsplit(filename, "_")[[1]]
  info = data.frame(ID = split[1],
                    right = split[2])
  
  return(info)
}

inf = get_info(filename)
```

Split the data by interlocutor and split these into 10 seconds long files. Save them in separate folders
```{r}
sampling = 100 #sampling of actigraph is 100 Hz
len = 10 #split into 10 seconds long
split = len * sampling

data_psych = subset(data, interviewer==1)
data_part = subset(data, interviewer==0)

rownames(data_psych)=NULL
rownames(data_part)=NULL

n_splits_psych = trunc((nrow(data_psych)/split),0)
n_splits_part = trunc((nrow(data_part)/split),0)

#trim data to have lenght dividable by number of splits
data_psych = data_psych[1:(n_splits_psych*split),]
data_part = data_part[1:(n_splits_part*split),]

data_psych$split = rep(1:n_splits_psych,each=split)
data_part$split = rep(1:n_splits_part, each=split)

splitted_psych = split(data_psych, data_psych$split)
splitted_part = split(data_part, data_part$split)

#loop through the list of dataframes, count utterances and save into its interlocutor's folder
for (d in 1:length(splitted_psych)) {
  dataframe = splitted_psych[[d]]
  save_path = "clean_data/Split_data/Interviewer/"
  filename = paste(info$ID, info$right, d, ".csv", sep = "_")
  save_as = paste0(save_path, filename)
  
  write.csv(dataframe, save_as)
}

#the same for splitted_part
for (d in 1:length(splitted_part)) {
  dataframe = splitted_part[[d]]
  save_path = "clean_data/Split_data/Participant/"
  filename = paste(inf$ID, inf$right, d, ".csv", sep = "_")
  save_as = paste0(save_path, filename)
  
  write.csv(dataframe, save_as)
}
```

# 2. Forming coordination pairs
Use the already splitted data into 10 seconds long chunks, combine them into pairs using the chunk order number (in the name of the file).

```{r}
#copy contents of 'Interviewer' folder into 'Coordination/Interviewer'
original_interviewer = "clean_data/Split_data/Interviewer"
copy_interviewer = "clean_data/Split_data/Coordination/Interviewer"
i_files = list.files(original_interviewer, full.names = T)
i_copy_success = file.copy(i_files, copy_interviewer)
sum(i_copy_success==F)

#copy contents of 'Participant' folder into 'Coordination/Participant'
original_participant = "clean_data/Split_data/Participant"
copy_participant = "clean_data/Split_data/Coordination/Participant"
p_files = list.files(original_participant, full.names = T)
p_copy_success = file.copy(p_files, copy_participant)
sum(p_copy_success==F)

#load all files from the 'Interviewer' and 'Participant' folders inside of Coordination folder
interviewer_files = list.files("clean_data/Split_data/Coordination/Interviewer")
participant_files = list.files("clean_data/Split_data/Coordination/Participant")

no_match_i = interviewer_files[(interviewer_files %in% participant_files) ==F]
no_match_p = participant_files[(participant_files %in% interviewer_files) ==F]

#sanity check
length(interviewer_files)-length(no_match_i) == length(participant_files)-length(no_match_p)

#delete files from both directories
for (i in no_match_i) {
  folder = "clean_data/Split_data/Coordination/Interviewer/"
  to_remove = paste0(folder, no_match_i[i])
  unlink(to_remove, recursive = T, force = T)
}

for (i in no_match_p) {
  folder = "clean_data/Split_data/Coordination/Participant/"
  to_remove = paste0(folder, no_match_p[i])
  unlink(to_remove, recursive = T, force = T)
}
```



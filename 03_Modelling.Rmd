---
title: "03 Modelling"
author: "Dominik Klepl"
date: "11/8/2018"
output: html_document
---

In the folder "clean_data/ML_ready" there are csv files with data almost ready to be fed into some models.
The RQA was run both with one average set of parameters and with parameters optimized uniquely for every time-series. First it needs to be decided which of these two to use.
Some filtering and transformation of the data is needed first.

Here are all the ML ready data.
```{r}
library(lme4)
library(tidyverse)
library(ggthemes)
all = list.files("clean_data/ML_ready", full.names = T)
```

Load all data
```{r load data}
data_c1 = read.csv(all[1])
data_c2 = read.csv(all[2])
data_i1 = read.csv(all[3])
data_i2 = read.csv(all[3])
data_p1 = read.csv(all[5])
data_p2 = read.csv(all[6])
```

# Which RQA data should be used?
```{r which parameters}
data_c1 = subset(data_c1, nbr.null<1500)
data_c2 = subset(data_c2, nbr.null<1500)
data_i1 = subset(data_i1, nbr.null<500)
data_i2 = subset(data_i2, nbr.null<500)
data_p1 = subset(data_p1, nbr.null<500)
data_p2 = subset(data_p2, nbr.null<500)

data_c1 = na.omit(data_c1)
data_c2 = na.omit(data_c2)
data_i1 = na.omit(data_i1)
data_i2 = na.omit(data_i2)
data_p1 = na.omit(data_p1)
data_p2 = na.omit(data_p2)

c1 = glmer(diagnosis ~ RR + (1|ID), data_c1, family = "binomial", control = glmerControl(calc.derivs = F))
c2 = glmer(diagnosis ~ RR + (1|ID), data_c2, family = "binomial", control = glmerControl(calc.derivs = F))
i1 = glmer(diagnosis ~ RR + (1|ID), data_i1, family = "binomial", control = glmerControl(calc.derivs = F))
i2 = glmer(diagnosis ~ RR + (1|ID), data_i2, family = "binomial", control = glmerControl(calc.derivs = F))
p1 = glmer(diagnosis ~ RR + (1|ID), data_p1, family = "binomial", control = glmerControl(calc.derivs = F))
p2 = glmer(diagnosis ~ RR + (1|ID), data_p2, family = "binomial", control = glmerControl(calc.derivs = F))

summary(c1)
summary(c2)
summary(i1)
summary(i2)
summary(p1)
summary(p2)

#clean the environment
rm(list = ls()[-1])
```

None of the models shows a significant difference in RR across diagnosis. Therefore all models will use the RQA results obtained with one set of parameters.

Load only the data that will be used
```{r load data}
data_c = read.csv(all[1])
data_i = read.csv(all[3])
data_p = read.csv(all[5])
```


# Final data processing
Before making any machine learning, the data needs to be treated for missing values, corrupt data-splits (where the actigraphs were not picking up almost any signal) and remove duplicate feature columns and columns that don't include any ML usable information.
```{r clean up}
#the same should be done to all data files I have => write a function
prepare_data = function(data, single=T) {
  #remove NAs
  data = na.omit(data)
  
  #remove signals that is more than 90% comprised of zeroes
  if (single==T) {
    data = subset(data, nbr.null<900)
  } else data = subset(data, nbr.null<1800)
  
  #remove unusable features
  
  data = data[,c(-23,-25,-27)]
  
  return(data)
}

#now clean up all 3 datasets
data_c = prepare_data(data_c, single = F)
data_i = prepare_data(data_i)
data_p = prepare_data(data_p)
```

For the sake of plotting and inspecting the data we turn all features to correct data-classes. This will be required every time the data is loaded => write a function.
```{r change classes}
change_classes = function(data) {
  factor_cols = c("ID", "diagnosis", "right")
  data[factor_cols] = lapply(data[factor_cols], as.factor)
  
  num_cols = c("n_utterances","nbr.null", "NRLINE", "maxL")
  data[num_cols] = lapply(data[num_cols], as.numeric)
  
  return(data)
}

data_c = change_classes(data_c)
data_i = change_classes(data_i)
data_p = change_classes(data_p)
```


The distribution is probably quite unbalanced, inspect the size of the imbalance and treat it appropriately.

Plot the sample sizes and save to a production-ready plot.
```{r plot class balance}
balance_c = ggplot(data_c, aes(x=diagnosis, fill=diagnosis))+
  geom_histogram(stat="count")+
  scale_x_discrete(labels=c("0"="Control", "1"="Patient"))+
  xlab("Coordination")+
  theme_few()+
  guides(fill=F)
balance_i = ggplot(data_i, aes(x=diagnosis, fill=diagnosis))+
  geom_histogram(stat="count")+
  scale_x_discrete(labels=c("0"="Control", "1"="Patient"))+
  theme_few()+
  guides(fill=F)+
  xlab("Interviewer")
balance_p = ggplot(data_p, aes(x=diagnosis, fill=diagnosis))+
  geom_histogram(stat="count")+
  scale_x_discrete(labels=c("0"="Control", "1"="Patient"))+
  theme_few()+
  guides(fill=F)+
  xlab("Participant")

library(grid)
class_balance = gridExtra::grid.arrange(balance_c, balance_i, balance_p, clip="on", ncol=3, top=textGrob("Sample size balance", gp=gpar(fontsize=20, font=3)))

ggsave("Figures/Class_balance.jpg", class_balance, width = 6, height = 2)
```

Get also the numbers for report.
```{r class balance numbers}
balance_data = data.frame(Patient = c(sum(data_c$diagnosis==1),
                                      sum(data_i$diagnosis==1),
                                      sum(data_p$diagnosis==1)),
                          Control = c(sum(data_c$diagnosis==0),
                                      sum(data_i$diagnosis==0),
                                      sum(data_p$diagnosis==0)),
                          row.names = c("Coordination", 
                                        "Interviewer", 
                                        "Participant"))
write.csv(balance_data, "Tables/Class_balance.csv")
```

Now rebalance the data so that the huge imbalance doesn't introduce bias to the models later on.
I'll upsample the data because with downsampling too much data (approx. 4000 per each dataset) would be lost.
```{r upsampling}
library(caret)
data_c = upSample(data_c, data_c$diagnosis)
data_i = upSample(data_i, data_i$diagnosis)
data_p = upSample(data_p, data_p$diagnosis)

#sanity check
sum(data_c$diagnosis==0) == sum(data_c$diagnosis==0)
sum(data_i$diagnosis==0) == sum(data_i$diagnosis==0)
sum(data_p$diagnosis==0) == sum(data_p$diagnosis==0)
```

Now all 3 datasets are truely ML-ready. Therefore we can save the final version now.
```{r save data}
write_csv(data_c, "clean_data/ML_ready/coordination_data_final.csv")
write_csv(data_i, "clean_data/ML_ready/interviewer_data_final.csv")
write_csv(data_p, "clean_data/ML_ready/participant_data_final.csv")
```



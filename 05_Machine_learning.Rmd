---
title: "05 Machine Learning"
author: "Dominik Klepl"
date: "11/10/2018"
output: html_document
---

# Required libraries
```{r}
pacman::p_load("caret", "DALEX", "caretEnsemble")
```

The data needs to be slightly transformed into caret-friendly data
```{r}
caret_friendly = function(data) {
  #store variables not used for models in separate df
  info_cols = c("ID", "right", "time")
  no_model = data[, info_cols]
  
  #and remove this columns from data
  data[, info_cols] = lapply(data[, info_cols], as.null)
  
  #all columns except for diagnosis and set should be numeric
  set = c(1, (which(colnames(data) == "set")))
  num_cols = colnames(data)[-set]
  data[, num_cols] = lapply(data[, num_cols], as.numeric)
  
  #relevel diagnosis so that Schizophrenia is first
  data$diagnosis = relevel(data$diagnosis, ref = "Schizophrenic")
  levels(data$diagnosis)
  
  #train-test split
  train = subset(data, set == "train")
  test = subset(data, set == "test")
  test$set = NULL
  train$set = NULL
  X_train = train[, 2:ncol(train)]
  X_test = test[, 2:ncol(train)]
  Y_train = train[, 1]
  Y_test = test[, 1]
  
  caret_friendly = list(
  X_train = X_train,
  X_test = X_test,
  Y_train = Y_train,
  Y_test = Y_test,
  no_model = no_model
  )
  
  return(caret_friendly)
}
```


THE OUTLINE
 1 Build predictive models using only participant data
    - choose max 3 algorithms to feed the data to - 10-fold 30-repeated CV (beat variance in subsampling with randomness)
    1.2 feed the 5 feature-filtered data to these algorithms - saving all models continuously!!!
    1.3 select the best feature-selection and best performing model


# 1 Participant models
The list of algorithms trained: 
    - Model averaged neural net ('avNNet')
    - eXtreme Gradient Boosting ('xgbDART')
    - Random Forest ('rf')
    - Naive Bayes ('naive_bayes')

## 1.2 Model training
```{r}
fitControl = trainControl(
  method = "repeatedcv",
  number = 10,
  repeats = 30,
  classProbs = TRUE,
  summaryFunction = twoClassSummary,
  allowParallel = T,
  verboseIter = FALSE
  )
```

Start parallel processing
```{r}
library(doParallel)
cl <- makePSOCKcluster(2)
registerDoParallel(cl, cores = 2)
```


### Boruta
```{r}
boruta_p = read.csv("clean_data/ML_data/Participant_boruta.csv")
boruta_p = caret_friendly(boruta_p)

boruta_avNNet = train(
  x = boruta_p$X_train,
  y = boruta_p$Y_train ,
  method = 'avNNet',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_avNNet, file="Models/Participant/boruta_keras.rds")
rm(boruta_keras)

boruta_xboost = train(
  x = boruta_p$X_train,
  y = boruta_p$Y_train ,
  method = 'xgbTree',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_xboost, file="Models/Participant/boruta_xboost.rds")
rm(boruta_xboost)

boruta_rf = train(
  x = boruta_p$X_train,
  y = boruta_p$Y_train ,
  method = 'rf',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_rf, file="Models/Participant/boruta_rf.rds")
rm(boruta_rf)

boruta_bayes = train(
  x = boruta_p$X_train,
  y = boruta_p$Y_train ,
  method = 'naive_bayes',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_bayes, file="Models/Participant/boruta_bayes.rds")

rm(boruta_bayes)
rm(boruta_p)
```

### Featexp
```{r}
featexp_p = read.csv("clean_data/ML_data/Participant_featexp.csv")
featexp_p = caret_friendly(featexp_p)

featexp_avNNet = train(
  x = featexp_p$X_train,
  y = featexp_p$Y_train ,
  method = 'avNNet',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
  )

saveRDS(featexp_avNNet, file="Models/Participant/featexp_keras.rds")
rm(featexp_keras)

featexp_xboost = train(
  x = featexp_p$X_train,
  y = featexp_p$Y_train ,
  method = 'xgbTree',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_xboost, file="Models/Participant/featexp_xboost.rds")
rm(featexp_xboost)

featexp_rf = train(
  x = featexp_p$X_train,
  y = featexp_p$Y_train ,
  method = 'rf',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_rf, file="Models/Participant/featexp_rf.rds")
rm(featexp_rf)

featexp_bayes = train(
  x = featexp_p$X_train,
  y = featexp_p$Y_train ,
  method = 'naive_bayes',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_bayes, file="Models/Participant/featexp_bayes.rds")
rm(featexp_bayes)
rm(featexp_p)
```

### Uncorrelated
```{r}
uncorrelated_p = read.csv("clean_data/ML_data/Participant_uncorrelated.csv")
uncorrelated_p = caret_friendly(uncorrelated_p)

uncorrelated_avNNet = train(
x = uncorrelated_p$X_train,
y = uncorrelated_p$Y_train ,
method = 'avNNet',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_avNNet, file="Models/Participant/uncorrelated_keras.rds")
rm(uncorrelated_keras)

uncorrelated_xboost = train(
x = uncorrelated_p$X_train,
y = uncorrelated_p$Y_train ,
method = 'xgbTree',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_xboost, file="Models/Participant/uncorrelated_xboost.rds")
rm(uncorrelated_xboost)

uncorrelated_rf = train(
x = uncorrelated_p$X_train,
y = uncorrelated_p$Y_train ,
method = 'rf',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_rf, file="Models/Participant/uncorrelated_rf.rds")
rm(uncorrelated_rf)

uncorrelated_bayes = train(
x = uncorrelated_p$X_train,
y = uncorrelated_p$Y_train ,
method = 'naive_bayes',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_bayes, file="Models/Participant/uncorrelated_bayes.rds")
rm(uncorrelated_bayes)
```

# Coordination

### Boruta
```{r}
boruta_c = read.csv("clean_data/ML_data/Coordination_boruta.csv")
boruta_c = caret_friendly(boruta_c)

boruta_avNNet = train(
  x = boruta_c$X_train,
  y = boruta_c$Y_train ,
  method = 'avNNet',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_avNNet, file="Models/Coordination/boruta_keras.rds")
rm(boruta_keras)

boruta_xboost = train(
  x = boruta_c$X_train,
  y = boruta_c$Y_train ,
  method = 'xgbTree',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_xboost, file="Models/Coordination/boruta_xboost.rds")
rm(boruta_xboost)

boruta_rf = train(
  x = boruta_c$X_train,
  y = boruta_c$Y_train ,
  method = 'rf',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_rf, file="Models/Coordination/boruta_rf.rds")
rm(boruta_rf)

boruta_bayes = train(
  x = boruta_c$X_train,
  y = boruta_c$Y_train ,
  method = 'naive_bayes',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(boruta_bayes, file="Models/Coordination/boruta_bayes.rds")

rm(boruta_bayes)
rm(boruta_c)
```

### Featexp
```{r}
featexp_c = read.csv("clean_data/ML_data/Coordination_featexp.csv")
featexp_c = caret_friendly(featexp_c)

featexp_avNNet = train(
  x = featexp_c$X_train,
  y = featexp_c$Y_train ,
  method = 'avNNet',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
  )

saveRDS(featexp_avNNet, file="Models/Coordination/featexp_keras.rds")
rm(featexp_keras)

featexp_xboost = train(
  x = featexp_c$X_train,
  y = featexp_c$Y_train ,
  method = 'xgbTree',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_xboost, file="Models/Coordination/featexp_xboost.rds")
rm(featexp_xboost)

featexp_rf = train(
  x = featexp_c$X_train,
  y = featexp_c$Y_train ,
  method = 'rf',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_rf, file="Models/Coordination/featexp_rf.rds")
rm(featexp_rf)

featexp_bayes = train(
  x = featexp_c$X_train,
  y = featexp_c$Y_train ,
  method = 'naive_bayes',
  trControl = fitControl,
  metric = "ROC",
  preProcess = c("center", "scale")
)

saveRDS(featexp_bayes, file="Models/Coordination/featexp_bayes.rds")
rm(featexp_bayes)
rm(featexp_c)
```

### Uncorrelated
```{r}
uncorrelated_c = read.csv("clean_data/ML_data/Coordination_uncorrelated.csv")
uncorrelated_c = caret_friendly(uncorrelated_c)

uncorrelated_avNNet = train(
x = uncorrelated_c$X_train,
y = uncorrelated_c$Y_train ,
method = 'avNNet',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_avNNet, file="Models/Coordination/uncorrelated_keras.rds")
rm(uncorrelated_keras)

uncorrelated_xboost = train(
x = uncorrelated_c$X_train,
y = uncorrelated_c$Y_train ,
method = 'xgbTree',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_xboost, file="Models/Coordination/uncorrelated_xboost.rds")
rm(uncorrelated_xboost)

uncorrelated_rf = train(
x = uncorrelated_c$X_train,
y = uncorrelated_c$Y_train ,
method = 'rf',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_rf, file="Models/Coordination/uncorrelated_rf.rds")
rm(uncorrelated_rf)

uncorrelated_bayes = train(
x = uncorrelated_c$X_train,
y = uncorrelated_c$Y_train ,
method = 'naive_bayes',
trControl = fitControl,
metric = "ROC",
preProcess = c("center", "scale")
)

saveRDS(uncorrelated_bayes, file="Models/Coordination/uncorrelated_bayes.rds")
rm(uncorrelated_bayes)
```

#Evaluate the models

## Participant

Load all trained models
```{r}
participant_model_path = list.files("Models/Participant", full.names = T)
models_participant = list()
model_names = list.files("Models/Participant")
model_names = strsplit(model_names, "\\.")
for (n in 1:length(participant_model_path)) {
  model = participant_model_path[n]
  name = model_names[[n]][1]
  models_participant[[name]]=readRDS(model)
}
```

## Coordination

Load all trained models
```{r}
coordination_model_path = list.files("Models/Coordination", full.names = T)
models_coordination = list()
model_names = list.files("Models/Coordination")
model_names = strsplit(model_names, "\\.")
for (n in 1:length(coordination_model_path)) {
  model = coordination_model_path[n]
  name = model_names[[n]][1]
  models_coordination[[name]]=readRDS(model)
}
```

#CODE MESS for evaluation

results = resamples(list(Participant=m1, Coordination=m2))
bwplot(results)

diff = diff(results)
summary(diff)

p_fun <- function(object, newdata){predict(object, newdata=newdata, type="prob")[,1]}
d2$diagnosis = ifelse(d2$diagnosis=="Control", 0, 1)
expl = explain(m2, d2[,-1], d2$diagnosis, predict_function = p_fun)
perf = model_performance(expl)
imp = variable_importance(expl, loss_function = loss_root_mean_square)
plot(perf)

plot(imp)

resp = variable_response(expl, variable = "mad_diff")
plot(resp)

p = predict(m2, newdata=d2[,-1], type="prob")


